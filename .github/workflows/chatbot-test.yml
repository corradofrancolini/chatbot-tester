# Chatbot Tester - GitHub Actions Workflow
# Esegue test automatici su chatbot web

name: Chatbot Test Suite

on:
  # Trigger manuale con parametri
  workflow_dispatch:
    inputs:
      project:
        description: 'Nome progetto'
        required: true
        type: string
      mode:
        description: 'Modalita test'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - assisted
          - train
      tests:
        description: 'Quali test eseguire'
        required: true
        default: 'pending'
        type: choice
        options:
          - all
          - pending
          - failed
      new_run:
        description: 'Crea nuovo run'
        required: false
        default: false
        type: boolean

  # Scheduled run (opzionale - decommentare per abilitare)
  # schedule:
  #   - cron: '0 2 * * *'  # Ogni notte alle 2:00

jobs:
  test:
    name: Run Chatbot Tests
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: |
          playwright install chromium
          playwright install-deps chromium

      - name: Setup project configuration
        run: |
          # Crea directory config se non esiste
          mkdir -p config

          # Se ci sono secrets, crea .env
          if [ -n "${{ secrets.LANGSMITH_API_KEY }}" ]; then
            echo "LANGSMITH_API_KEY=${{ secrets.LANGSMITH_API_KEY }}" >> config/.env
          fi

      - name: Create my-chatbot project
        if: ${{ inputs.project == 'my-chatbot' }}
        run: |
          mkdir -p projects/my-chatbot

          # Crea project.yaml
          cat > projects/my-chatbot/project.yaml << 'EOF'
          project:
            name: my-chatbot
            description: Chatbot Silicon Search B
            created: '2024-12-04'
            language: it

          chatbot:
            url: https://platform-dev.server-01.example.com/api/llm/app-silicon-search-B/it
            selectors:
              textarea: '#llm-prompt-textarea'
              submit_button: button.llm__prompt-submit
              bot_messages: .llm__message--assistant
              thread_container: .llm__scroller
              loading_indicator: .llm__busyIndicator
            screenshot_css: ''
            timeouts:
              page_load: 30000
              bot_response: 60000

          test_defaults:
            email: test@example.com
            countries:
              - Italy
            confirmations:
              - 'yes'
              - 'no'

          google_sheets:
            enabled: ${{ secrets.GOOGLE_CREDENTIALS_JSON != '' }}
            spreadsheet_id: 'YOUR_SPREADSHEET_ID'
            drive_folder_id: 'YOUR_DRIVE_FOLDER_ID'

          langsmith:
            enabled: ${{ secrets.LANGSMITH_API_KEY != '' }}
            api_key_env: LANGSMITH_API_KEY
            project_id: YOUR_LANGSMITH_PROJECT_ID
            org_id: ''
            tool_names: []

          ollama:
            enabled: false
            model: llama3.2:3b
            url: http://localhost:11434/api/generate
          EOF

          # Crea tests.json con alcuni test di esempio
          cat > projects/my-chatbot/tests.json << 'EOF'
          [
            {"id": "TEST_001", "question": "Puoi mostrarmi prima le novità e i bestsellers nei risultati di ricerca?", "followups": []},
            {"id": "TEST_002", "question": "La mia azienda opera nel commercio di caffè; abbiamo un evento di presentazione di una nuova cialda. Che gadget posso proporre?", "followups": []},
            {"id": "TEST_003", "question": "Puoi mostrarmi prodotti a basso costo?", "followups": []},
            {"id": "TEST_004", "question": "Trova i dettagli del prodotto con il codice articolo K18040", "followups": []},
            {"id": "TEST_005", "question": "Quali penne avete a meno di 1 euro?", "followups": []}
          ]
          EOF

          # Crea run_config.json
          cat > projects/my-chatbot/run_config.json << 'EOF'
          {
            "env": "DEV",
            "prompt_version": "",
            "model_version": "",
            "active_run": null,
            "run_start": null,
            "tests_completed": 0,
            "mode": "auto",
            "last_test_id": null,
            "dry_run": false,
            "use_langsmith": true,
            "use_rag": false,
            "use_ollama": false,
            "single_turn": true
          }
          EOF

          echo "✓ Progetto my-chatbot creato"
          ls -la projects/my-chatbot/

      - name: Run health check
        run: |
          python run.py --health-check -p ${{ inputs.project || 'default' }} || true

      - name: Execute tests
        id: tests
        run: |
          NEW_RUN_FLAG=""
          if [ "${{ inputs.new_run }}" == "true" ]; then
            NEW_RUN_FLAG="--new-run"
          fi

          python run.py \
            -p ${{ inputs.project || 'default' }} \
            -m ${{ inputs.mode || 'auto' }} \
            --tests ${{ inputs.tests || 'pending' }} \
            --no-interactive \
            --headless \
            --skip-health-check \
            $NEW_RUN_FLAG
        env:
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-${{ github.run_number }}
          path: |
            reports/
          retention-days: 30

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots-${{ github.run_number }}
          path: |
            reports/**/screenshots/
          retention-days: 14

      - name: Summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: ${{ inputs.project || 'default' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: ${{ inputs.mode || 'auto' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests**: ${{ inputs.tests || 'pending' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Conta risultati se il report esiste
          if [ -d "reports" ]; then
            PASS=$(grep -r "PASS" reports/*.html 2>/dev/null | wc -l || echo "0")
            FAIL=$(grep -r "FAIL" reports/*.html 2>/dev/null | wc -l || echo "0")
            echo "- **Passed**: $PASS" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed**: $FAIL" >> $GITHUB_STEP_SUMMARY
          fi

  # Job opzionale per notifiche (decommentare per abilitare)
  # notify:
  #   name: Send Notification
  #   needs: test
  #   runs-on: ubuntu-latest
  #   if: always()
  #   steps:
  #     - name: Notify Slack
  #       if: ${{ secrets.SLACK_WEBHOOK_URL }}
  #       uses: slackapi/slack-github-action@v1
  #       with:
  #         payload: |
  #           {
  #             "text": "Chatbot Test completed: ${{ needs.test.result }}",
  #             "blocks": [
  #               {
  #                 "type": "section",
  #                 "text": {
  #                   "type": "mrkdwn",
  #                   "text": "*Chatbot Test Results*\nProject: ${{ inputs.project }}\nStatus: ${{ needs.test.result }}"
  #                 }
  #               }
  #             ]
  #           }
  #       env:
  #         SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
